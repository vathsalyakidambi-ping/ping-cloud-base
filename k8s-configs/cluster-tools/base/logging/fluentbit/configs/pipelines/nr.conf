# Kubernetes inputs
[INPUT]
    Name                tail
    Tag                 nr.kube.*
    Path                /var/log/containers/*_external-dns_*.log
    multiline.parser    docker, cri
    DB                  /fluent-bit/state/flb_nr_dns.db
    Mem_Buf_Limit       50MB
    Skip_Long_Lines     Off
    Refresh_Interval    10
    Rotate_Wait         30
    storage.type        filesystem
    Read_from_Head      ${READ_FROM_HEAD}

[INPUT]
    Name                tail
    Tag                 nr.kube.*
    Path                /var/log/containers/*_kube-system_*.log
    Exclude_Path        *kube-proxy*.log, *sealed-secrets-controller*.log
    multiline.parser    docker, cri
    DB                  /fluent-bit/state/flb_nr_system.db
    Mem_Buf_Limit       50MB
    Skip_Long_Lines     Off
    Refresh_Interval    10
    Rotate_Wait         30
    storage.type        filesystem
    Read_from_Head      ${READ_FROM_HEAD}

# Node log inputs
[INPUT]
    Name                tail
    Tag                 nr.host.dmesg
    Path                /var/log/dmesg
    Parser              dmesg
    DB                  /fluent-bit/state/flb_nr_dmesg.db
    Mem_Buf_Limit       5MB
    Skip_Long_Lines     On
    Refresh_Interval    10
    Read_from_Head      ${READ_FROM_HEAD}

[INPUT]
    Name                tail
    Tag                 nr.host.messages
    Path                /var/log/messages
    Parser              syslog
    DB                  /fluent-bit/state/flb_nr_messages.db
    Mem_Buf_Limit       5MB
    Skip_Long_Lines     On
    Refresh_Interval    10
    Read_from_Head      ${READ_FROM_HEAD}

[INPUT]
    Name                tail
    Tag                 nr.host.secure
    Path                /var/log/secure
    Parser              syslog
    DB                  /fluent-bit/state/flb_nr_secure.db
    Mem_Buf_Limit       5MB
    Skip_Long_Lines     On
    Refresh_Interval    10
    Read_from_Head      ${READ_FROM_HEAD}

[INPUT]
    Name                systemd
    Tag                 nr.dataplane.systemd.*
    Systemd_Filter      _SYSTEMD_UNIT=docker.service
    DB                  /fluent-bit/state/flb_nr_systemd.db
    Path                /var/log/journal
    Read_From_Tail      ${READ_FROM_TAIL}

# Kubernetes filters

[FILTER]
    Name           kubernetes
    Match          nr.kube.*
    Kube_URL       https://kubernetes.default.svc:443
    Kube_Tag_Prefix nr.kube.var.log.containers.
    Buffer_Size    32k
    K8S-Logging.Exclude Off
    Labels         Off
    Annotations    Off
    Cache_Use_Docker_Id On
    Kube_Meta_Cache_TTL 1800

[FILTER]
    Name           nest
    Match          nr.kube.*
    Operation      lift
    Nested_under   kubernetes

[FILTER]
    Name           record_modifier
    Match          nr.kube.*
    Record         cluster_name ${NR_CLUSTER_NAME}
    Allowlist_key  container_name
    Allowlist_key  namespace_name
    Allowlist_key  pod_name
    Allowlist_key  stream
    Allowlist_key  message
    Allowlist_key  log

# Node log filters

[FILTER]
    Name                modify
    Match               nr.dataplane.systemd.*
    Rename              _HOSTNAME                   hostname
    Rename              _SYSTEMD_UNIT               systemd_unit
    Rename              MESSAGE                     log
    Remove_regex        ^((?!hostname|systemd_unit|log).)*$

[FILTER]
    Name                aws
    Match               nr.dataplane.*
    imds_version        v1

[FILTER]
    Name                record_modifier
    Match               nr.dataplane.*
    Record              cluster_name ${NR_CLUSTER_NAME}

[FILTER]
    Name                aws
    Match               nr.host.*
    private_ip          true
    imds_version        v1
    hostname            true

[FILTER]
    Name                lua
    Match               nr.host.*
    script              time.lua
    call                append_tag

[FILTER]
    Name                record_modifier
    Match               nr.host.*
    Record              cluster_name ${NR_CLUSTER_NAME}

# Output

[OUTPUT]
    Name                nrlogs
    Alias               nr_out
    Match               nr.*
    license_key         ${NR_LICENSE_KEY}
    Retry_Limit         False